# Définition d'un "upstream" pour le frontend
upstream frontend_service {                         # Nom logique du groupe de serveurs frontend
    server frontend:3000;                           # Le service Docker "frontend" écoute sur le port 3000
}

# Définition d'un "upstream" pour le backend
upstream backend_service {                          # Nom logique du groupe de serveurs backend
    server backend:3000;                            # Le service Docker "backend" écoute sur le port 3000
}

server {
    listen 80;                                      # Nginx écoute sur le port 80 (HTTP)
    server_name _;                                  # Accepte toutes les requêtes (localhost inclus)

    # ---------------------- FRONTEND ----------------------
    location / {                                    # Pour toutes les requêtes sur la racine "/"
        proxy_pass http://frontend_service;         # On les redirige vers le frontend (React)
        proxy_set_header Host $host;                # On garde l'en-tête Host d'origine
        proxy_set_header X-Real-IP $remote_addr;    # On transmet l'IP réelle du client
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # On gère la chaîne des proxies
        proxy_set_header X-Forwarded-Proto $scheme; # On transmet le protocole (http / https)
    }

    # ---------------------- API 1 ----------------------
    location /api1/ {                               # Toutes les requêtes commençant par /api1/
        proxy_pass http://backend_service/api1/;    # Redirection vers l'API backend sur /api1/
        proxy_set_header Host $host;                # Transmission des en-têtes standards
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ---------------------- API 2 ----------------------
    location /api2/ {                               # Toutes les requêtes commençant par /api2/
        proxy_pass http://backend_service/api2/;    # Redirection vers l'API backend sur /api2/
        proxy_set_header Host $host;                # Transmission des en-têtes standards
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
